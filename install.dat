DROP TABLE IF EXISTS `actions`;

CREATE TABLE `actions` (
  `id` int NOT NULL,
  `time` int NOT NULL DEFAULT '0',
  `timer` int NOT NULL DEFAULT '0',
  `card_number` varchar(15) NOT NULL DEFAULT '',
  `pool_id` int NOT NULL DEFAULT '0',
  `device` int NOT NULL DEFAULT '0',
  `action` varchar(255) NOT NULL DEFAULT '',
  `data` text NOT NULL,
  `count` int NOT NULL DEFAULT '0',
  `progress` int NOT NULL DEFAULT '0',
  `status` enum('inprogress','waiting','suspension','suspended','preparing','') CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL DEFAULT 'waiting',
  `success` int NOT NULL DEFAULT '0',
  `errors` int NOT NULL DEFAULT '0',
  `uniq` varchar(8) NOT NULL DEFAULT '0',
  `report` text NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;

DROP TABLE IF EXISTS `answer`;

CREATE TABLE `answer` (
  `step` int(9) NOT NULL,
  `answer` text NOT NULL,
  `device` int(9) NOT NULL DEFAULT '0',
  `time` int(11) NOT NULL DEFAULT '0'
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `call_incoming`;

CREATE TABLE `call_incoming` (
  `id` int NOT NULL,
  `time` int NOT NULL DEFAULT '0',
  `number` varchar(15) NOT NULL DEFAULT '',
  `incoming` varchar(15) NOT NULL,
  `device` int NOT NULL DEFAULT '0'
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `card2action`;

CREATE TABLE `card2action` (
  `id` int(9) NOT NULL,
  `device` int(1) NOT NULL DEFAULT '0',
  `action` int(9) NOT NULL DEFAULT '0',
  `row` int(9) NOT NULL DEFAULT '0',
  `place` varchar(38) NOT NULL DEFAULT ''
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `cards2folder`;

CREATE TABLE `cards2folder` (
  `id` int NOT NULL,
  `iccid` varchar(20) NOT NULL,
  `number` varchar(15) NOT NULL DEFAULT '',
  `title` varchar(32) NOT NULL DEFAULT '',
  `operator` varchar(16) NOT NULL DEFAULT '0',
  `balance` double NOT NULL DEFAULT '0',
  `place` varchar(6) NOT NULL DEFAULT '' COMMENT 'Ряд;Место(10;8) или ДорожкаМесто(A0)',
  `time` int NOT NULL DEFAULT '0',
  `time_number` int NOT NULL DEFAULT '0',
  `time_balance` int NOT NULL DEFAULT '0',
  `time_sms` int NOT NULL DEFAULT '0',
  `comment` text NOT NULL,
  `folder_id` int NOT NULL DEFAULT '0',
  `done` tinyint NOT NULL DEFAULT '0'
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT;

DROP TABLE IF EXISTS `card2pool`;

CREATE TABLE `card2pool` (
  `id` int(9) NOT NULL,
  `pool` int(9) NOT NULL DEFAULT '0',
  `card` varchar(15) NOT NULL DEFAULT ''
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `cards`;

CREATE TABLE `cards` (
  `id` int NOT NULL,
  `iccid` varchar(20) NOT NULL,
  `num` int NOT NULL DEFAULT '0',
  `number` varchar(15) NOT NULL DEFAULT '',
  `title` varchar(32) NOT NULL DEFAULT '',
  `operator` varchar(16) NOT NULL DEFAULT '0',
  `roaming` tinyint(1) NOT NULL DEFAULT '0',
  `device` int NOT NULL DEFAULT '0',
  `folder` varchar(32) NOT NULL DEFAULT '',
  `balance` double NOT NULL DEFAULT '0',
  `last_balance` double NOT NULL DEFAULT '0',
  `place` varchar(6) NOT NULL DEFAULT '',
  `time` int NOT NULL DEFAULT '0',
  `status` enum('free','inprogress','waiting') NOT NULL DEFAULT 'free',
  `time_number` int NOT NULL DEFAULT '0',
  `time_balance` int NOT NULL DEFAULT '0',
  `time_last_balance` int NOT NULL DEFAULT '0',
  `time_sms` int NOT NULL DEFAULT '0',
  `comment` varchar(255) NOT NULL DEFAULT ''
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 ROW_FORMAT=COMPACT;

DROP TABLE IF EXISTS `flags`;

CREATE TABLE `flags` (
  `id` int NOT NULL,
  `time` int NOT NULL DEFAULT '0',
  `name` varchar(15) NOT NULL DEFAULT '',
  `device` int NOT NULL DEFAULT '0',
  `value` varchar(32) NOT NULL DEFAULT '1'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 ROW_FORMAT=COMPACT;

DROP TABLE IF EXISTS `folders`;

CREATE TABLE `folders` (
  `id` int NOT NULL,
  `time` int NOT NULL DEFAULT '0',
  `title` varchar(32) NOT NULL DEFAULT '',
  `comment` varchar(200) NOT NULL DEFAULT ''
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO `folders` (`id`, `title`, `comment`) VALUES
(1, 'default', 'Диск по умолчанию');

DROP TABLE IF EXISTS `devices`;

CREATE TABLE `devices` (
  `id` int NOT NULL,
  `title` varchar(60) NOT NULL DEFAULT '',
  `model` enum('','SR-Train','SR-Nano-500','SR-Nano-1000','SR-Box-8','SR-Box-Bank','SR-Organizer') NOT NULL DEFAULT '',
  `token_local` varchar(5) NOT NULL DEFAULT '',
  `token_remote` varchar(10) NOT NULL DEFAULT '',
  `modems` varchar(64) NOT NULL DEFAULT '',
  `ip` varchar(21) NOT NULL DEFAULT '',
  `type` enum('client','server') NOT NULL DEFAULT 'client',
  `time` int NOT NULL DEFAULT '0',
  `init` int NOT NULL DEFAULT '0',
  `step` int NOT NULL DEFAULT '100',
  `data` text NOT NULL,
  `status` enum('free','inprogress','waiting') NOT NULL DEFAULT 'free',
  `serial` varchar(18) NOT NULL DEFAULT '',
  `serial_time` int NOT NULL DEFAULT '0',
  `pause` int NOT NULL DEFAULT '0',
  `folder` varchar(255) NOT NULL DEFAULT 'a:3:{s:5:"title";s:7:"Default";s:4:"time";s:1:"0";s:7:"comment";s:23:"По умолчанию";}',
  `press` int NOT NULL DEFAULT '0',
  `errors` int NOT NULL DEFAULT '0',
  `msg` varchar(255) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `link_incoming`;

CREATE TABLE `link_incoming` (
  `id` int(9) NOT NULL,
  `time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `device` int(9) NOT NULL DEFAULT '0',
  `step` int(9) NOT NULL DEFAULT '0',
  `answer` text NOT NULL,
  `uniq` varchar(8) NOT NULL DEFAULT ''
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Ответы агрегаторов';

DROP TABLE IF EXISTS `link_outgoing`;

CREATE TABLE `link_outgoing` (
  `id` int(9) NOT NULL,
  `time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `device` int(9) NOT NULL DEFAULT '0',
  `step` int(9) NOT NULL DEFAULT '0',
  `command` text NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Очередь команд для агрегаторов';

DROP TABLE IF EXISTS `modems`;

CREATE TABLE `modems` (
  `id` int(9) NOT NULL,
  `time` int(11) NOT NULL DEFAULT '0',
  `device` int(9) NOT NULL DEFAULT '0',
  `modems` text NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `operators`;

CREATE TABLE `operators` (
  `id` int(9) NOT NULL,
  `title` varchar(60) NOT NULL DEFAULT '',
  `name` varchar(32) NOT NULL DEFAULT '',
  `color` varchar(6) NOT NULL DEFAULT '',
  `get_number` varchar(32) NOT NULL DEFAULT '',
  `get_number_type` enum('ussd','sms','none') NOT NULL DEFAULT 'none',
  `get_balance` varchar(32) NOT NULL DEFAULT '',
  `get_balance_type` enum('ussd','sms','none','') NOT NULL DEFAULT 'none',
  `time` int(11) NOT NULL DEFAULT '0'
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Сотовые операторы';

INSERT INTO `operators` (`id`, `title`, `name`, `color`, `get_number`, `get_number_type`, `get_balance`, `get_balance_type`, `time`) VALUES
(1, 'Билайн', 'Bee Line GSM', 'FFBB00', '*110*10#', 'sms', '#102#', 'ussd', 1588081415),
(2, 'МТС', 'MTS', 'FF0000', '*111*0887#', 'sms', '#100#', 'ussd', 1583842346),
(3, 'Мегафон', 'MegaFon', '00AA66', '*205#', 'ussd', '*100#', 'ussd', 1588078856),
(4, 'Теле2', 'tele2', '000000', '', 'none', '', 'none', 0),
(5, 'Yota', 'Yota', '0088FF', '*103#', 'ussd', '*100#', 'ussd', 1588084453);

DROP TABLE IF EXISTS `pools`;

CREATE TABLE `pools` (
  `id` int NOT NULL,
  `title` varchar(32) NOT NULL DEFAULT '',
  `time` int NOT NULL DEFAULT '0',
  `status` enum('free','inprogress','waiting','') NOT NULL DEFAULT 'free',
  `marker` int NOT NULL DEFAULT '0',
  `key` varchar(32) NOT NULL DEFAULT ''
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `reports`;

CREATE TABLE `reports` (
  `id` int NOT NULL,
  `time_begin` int NOT NULL DEFAULT '0',
  `time_end` int NOT NULL DEFAULT '0',
  `place` text NOT NULL,
  `card_number` varchar(15) NOT NULL,
  `pool_id` int NOT NULL DEFAULT '0',
  `device` int NOT NULL DEFAULT '0',
  `action` varchar(255) NOT NULL DEFAULT '',
  `count` int NOT NULL DEFAULT '0',
  `success` int NOT NULL DEFAULT '0',
  `errors` int NOT NULL DEFAULT '0',
  `report` text NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 ROW_FORMAT=COMPACT;

DROP TABLE IF EXISTS `sms_incoming`;

CREATE TABLE `sms_incoming` (
  `id` int(9) NOT NULL,
  `time` int(11) NOT NULL DEFAULT '0',
  `modified` int(11) NOT NULL DEFAULT '0',
  `number` varchar(15) NOT NULL DEFAULT '',
  `sender` varchar(15) NOT NULL DEFAULT '',
  `txt` text NOT NULL,
  `readed` tinyint(1) NOT NULL DEFAULT '0'
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Входящие SMS';

DROP TABLE IF EXISTS `staff`;

CREATE TABLE `staff` (
  `id` int NOT NULL,
  `time` int NOT NULL DEFAULT '0',
  `name` varchar(32) NOT NULL DEFAULT '',
  `login` varchar(32) NOT NULL DEFAULT '',
  `pass` varchar(32) NOT NULL DEFAULT '',
  `pool` int NOT NULL DEFAULT '0',
  `timer` int NOT NULL DEFAULT '300'
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `users`;

CREATE TABLE `users` (
  `id` int(9) NOT NULL,
  `login` varchar(32) NOT NULL DEFAULT '',
  `pass` varchar(32) NOT NULL DEFAULT '',
  `email` varchar(64) NOT NULL DEFAULT ''
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Пользователи';

INSERT INTO `users` (`id`, `login`, `pass`, `email`) VALUES
(1, 'admin', 'admin', '');

DROP TABLE IF EXISTS `values`;

CREATE TABLE `values` (
  `id` int(9) NOT NULL,
  `name` varchar(32) NOT NULL DEFAULT '',
  `value` text NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO `values` (`id`, `name`, `value`) VALUES
(1, 'page_limit', '100'),
(2, 'main_menu', 'Настройки - setup.php\r\nАгрегаторы - setup_devices.php;submenu\r\nОператоры - setup_operators.php;submenu\r\nSIM-карты - cards.php\r\nПулы - pools.php;submenu\r\nДиски - folders.php;submenu\r\nOnline - online.php;submenu\r\nВызовы - call.php\r\nSMS - sms.php\r\nЗадачи - actions.php\r\nОтчеты - reports.php;submenu\r\nTerminal - terminal.php'),
(3, 'term_int', '500'),
(4, 'phone_prefix', '7'),
(5, 'terminal_hot', 'restart;buffer>;modem>;sms>;version;ATH0;AT+CREG?'),
(6, 'log_size', '1000');

ALTER TABLE `actions`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `number` (`id`),
  ADD KEY `operator` (`id`),
  ADD KEY `time` (`id`);

ALTER TABLE `answer`
  ADD PRIMARY KEY (`step`),
  ADD KEY `time` (`time`);

ALTER TABLE `card2action`
  ADD PRIMARY KEY (`id`),
  ADD KEY `action` (`action`) USING BTREE,
  ADD KEY `modems` (`row`) USING BTREE;

ALTER TABLE `cards2folder`
  ADD PRIMARY KEY (`id`),
  ADD KEY `folder_id` (`folder_id`),
  ADD KEY `done` (`done`);

ALTER TABLE `card2pool`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `card2pool` (`pool`,`card`) USING BTREE,
  ADD KEY `card` (`card`),
  ADD KEY `pool` (`pool`);

ALTER TABLE `call_incoming`
  ADD PRIMARY KEY (`id`),
  ADD KEY `time` (`time`),
  ADD KEY `number` (`number`),
  ADD KEY `incoming` (`incoming`);

ALTER TABLE `cards`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `number` (`number`),
  ADD KEY `operator` (`number`),
  ADD KEY `time` (`number`),
  ADD KEY `title` (`title`),
  ADD KEY `time_number` (`time_number`),
  ADD KEY `time_balance` (`time_balance`),
  ADD KEY `time_sms` (`time_sms`),
  ADD KEY `folder` (`folder`),
  ADD KEY `place` (`place`) USING BTREE,
  ADD KEY `status` (`status`);

ALTER TABLE `flags`
  ADD UNIQUE KEY `namedev` (`name`,`device`),
  ADD KEY `id` (`id`),
  ADD KEY `name` (`name`),
  ADD KEY `device` (`device`);

ALTER TABLE `folders`
  ADD PRIMARY KEY (`id`),
  ADD KEY `title` (`title`);

ALTER TABLE `devices`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `token_remote` (`token_remote`),
  ADD KEY `ip` (`id`),
  ADD KEY `time` (`id`);

ALTER TABLE `link_incoming`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `uniq` (`device`,`step`,`uniq`) USING BTREE,
  ADD KEY `device` (`device`),
  ADD KEY `step` (`step`);

ALTER TABLE `link_outgoing`
  ADD PRIMARY KEY (`id`),
  ADD KEY `device` (`device`),
  ADD KEY `step` (`step`);

ALTER TABLE `modems`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `device` (`device`) USING BTREE,
  ADD KEY `time` (`id`);

ALTER TABLE `operators`
  ADD PRIMARY KEY (`id`),
  ADD KEY `name` (`name`) USING BTREE;

ALTER TABLE `pools`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `title` (`user_id`,`title`),
  ADD KEY `status` (`status`),
  ADD KEY `key` (`key`);

ALTER TABLE `reports`
  ADD PRIMARY KEY (`id`),
  ADD KEY `time` (`time_begin`);

ALTER TABLE `sms_incoming`
  ADD PRIMARY KEY (`id`),
  ADD KEY `time` (`time`),
  ADD KEY `sender` (`sender`),
  ADD KEY `readed` (`readed`),
  ADD KEY `number` (`number`),
  ADD KEY `modified` (`modified`) USING BTREE;

ALTER TABLE `staff`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `login` (`login`),
  ADD KEY `name` (`name`) USING BTREE,
  ADD KEY `time` (`time`),
  ADD KEY `pool` (`pool`);

ALTER TABLE `users`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `login` (`id`);

ALTER TABLE `values`
  ADD UNIQUE KEY `id` (`id`),
  ADD KEY `name` (`name`);

ALTER TABLE `actions`
  MODIFY `id` int(9) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `answer`
  MODIFY `step` int(9) NOT NULL AUTO_INCREMENT;

ALTER TABLE `call_incoming`
  MODIFY `id` int NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `card2action`
  MODIFY `id` int(9) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `cards2folder`
  MODIFY `id` int NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `card2pool`
  MODIFY `id` int(9) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `cards`
  MODIFY `id` int(9) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `devices`
  MODIFY `id` int(1) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `flags`
  MODIFY `id` int NOT NULL AUTO_INCREMENT;

ALTER TABLE `folders`
  MODIFY `id` int NOT NULL AUTO_INCREMENT;

ALTER TABLE `link_incoming`
  MODIFY `id` int(9) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `link_outgoing`
  MODIFY `id` int(9) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `modems`
  MODIFY `id` int(9) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `operators`
  MODIFY `id` int(9) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

ALTER TABLE `pools`
  MODIFY `id` int(9) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `reports`
  MODIFY `id` int(9) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `sms_incoming`
  MODIFY `id` int(9) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `staff`
  MODIFY `id` int NOT NULL AUTO_INCREMENT;

ALTER TABLE `users`
  MODIFY `id` int(9) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=1;

ALTER TABLE `values`
  MODIFY `id` int(9) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=7;
